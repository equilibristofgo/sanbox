jose@x230n:~/git/equilibristofgo/sandbox/05_race_condition/v4$ ./race_test.sh 
==================
WARNING: DATA RACE
Read at 0x00c0000783d8 by goroutine 11:
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:50 +0xf2
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).StartWaiting.func1()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:37 +0x4c

Previous write at 0x00c0000783d8 by goroutine 7:
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:51 +0x144
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.TestRemoteJobRunner()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/main_test.go:33 +0x3cd
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.(*T).Run.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x47

Goroutine 11 (running) created at:
  time.goFunc()
      /usr/lib/go-1.18/src/time/sleep.go:176 +0x47

Goroutine 7 (running) created at:
  testing.(*T).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x724
  testing.runTests.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1839 +0x99
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.runTests()
      /usr/lib/go-1.18/src/testing/testing.go:1837 +0x7e4
  testing.(*M).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1719 +0xa71
  main.main()
      _testmain.go:47 +0x2e4
==================
==================
WARNING: DATA RACE
Read at 0x00c000182120 by goroutine 11:
  runtime.mapaccess1_faststr()
      /usr/lib/go-1.18/src/runtime/map_faststr.go:13 +0x0
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:54 +0x1c8
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).StartWaiting.func1()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:37 +0x4c

Previous write at 0x00c000182120 by goroutine 7:
  runtime.mapassign_faststr()
      /usr/lib/go-1.18/src/runtime/map_faststr.go:203 +0x0
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:55 +0x288
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.TestRemoteJobRunner()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/main_test.go:33 +0x3cd
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.(*T).Run.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x47

Goroutine 11 (running) created at:
  time.goFunc()
      /usr/lib/go-1.18/src/time/sleep.go:176 +0x47

Goroutine 7 (running) created at:
  testing.(*T).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x724
  testing.runTests.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1839 +0x99
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.runTests()
      /usr/lib/go-1.18/src/testing/testing.go:1837 +0x7e4
  testing.(*M).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1719 +0xa71
  main.main()
      _testmain.go:47 +0x2e4
==================
==================
WARNING: DATA RACE
Read at 0x00c000196088 by goroutine 11:
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:54 +0x1d5
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).StartWaiting.func1()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:37 +0x4c

Previous write at 0x00c000196088 by goroutine 7:
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:55 +0x294
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.TestRemoteJobRunner()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/main_test.go:33 +0x3cd
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.(*T).Run.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x47

Goroutine 11 (running) created at:
  time.goFunc()
      /usr/lib/go-1.18/src/time/sleep.go:176 +0x47

Goroutine 7 (running) created at:
  testing.(*T).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x724
  testing.runTests.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1839 +0x99
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.runTests()
      /usr/lib/go-1.18/src/testing/testing.go:1837 +0x7e4
  testing.(*M).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1719 +0xa71
  main.main()
      _testmain.go:47 +0x2e4
==================
==================
WARNING: DATA RACE
Read at 0x00c000180050 by goroutine 11:
  runtime.slicecopy()
      /usr/lib/go-1.18/src/runtime/slice.go:295 +0x0
  net/http.Header.Clone()
      /usr/lib/go-1.18/src/net/http/header.go:112 +0x264
  net/http.cloneOrMakeHeader()
      /usr/lib/go-1.18/src/net/http/clone.go:69 +0x365
  net/http.(*Client).makeHeadersCopier()
      /usr/lib/go-1.18/src/net/http/client.go:754 +0x75
  net/http.(*Client).do()
      /usr/lib/go-1.18/src/net/http/client.go:614 +0x165
  net/http.(*Client).Do()
      /usr/lib/go-1.18/src/net/http/client.go:593 +0x399
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:28 +0x37d
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).StartWaiting.func1()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:37 +0x4c

Previous write at 0x00c000180050 by goroutine 7:
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:55 +0x204
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8e
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xb9
  github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa7
  github.com/equilibristofgo/sandbox/05_race_condition/v4.TestRemoteJobRunner()
      /home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/main_test.go:33 +0x3cd
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.(*T).Run.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x47

Goroutine 11 (running) created at:
  time.goFunc()
      /usr/lib/go-1.18/src/time/sleep.go:176 +0x47

Goroutine 7 (running) created at:
  testing.(*T).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1486 +0x724
  testing.runTests.func1()
      /usr/lib/go-1.18/src/testing/testing.go:1839 +0x99
  testing.tRunner()
      /usr/lib/go-1.18/src/testing/testing.go:1439 +0x213
  testing.runTests()
      /usr/lib/go-1.18/src/testing/testing.go:1837 +0x7e4
  testing.(*M).Run()
      /usr/lib/go-1.18/src/testing/testing.go:1719 +0xa71
  main.main()
      _testmain.go:47 +0x2e4
==================
panic: test timed out after 30s

goroutine 7 [running]:
testing.(*M).startAlarm.func1()
	/usr/lib/go-1.18/src/testing/testing.go:2029 +0xbb
created by time.goFunc
	/usr/lib/go-1.18/src/time/sleep.go:176 +0x48

goroutine 1 [chan receive]:
testing.(*T).Run(0xc00011ad00, {0x89edf2, 0x13}, 0x8cb5b0)
	/usr/lib/go-1.18/src/testing/testing.go:1487 +0x750
testing.runTests.func1(0x0?)
	/usr/lib/go-1.18/src/testing/testing.go:1839 +0x9a
testing.tRunner(0xc00011ad00, 0xc000131ba0)
	/usr/lib/go-1.18/src/testing/testing.go:1439 +0x214
testing.runTests(0xc000111220?, {0xb128c0, 0x1, 0x1}, {0x40?, 0x7eff6e2a2658?, 0xb20440?})
	/usr/lib/go-1.18/src/testing/testing.go:1837 +0x7e5
testing.(*M).Run(0xc000111220)
	/usr/lib/go-1.18/src/testing/testing.go:1719 +0xa72
main.main()
	_testmain.go:47 +0x2e5

goroutine 4 [semacquire]:
sync.runtime_SemacquireMutex(0xc000078408?, 0x80?, 0xc000078408?)
	/usr/lib/go-1.18/src/runtime/sema.go:71 +0x25
sync.(*RWMutex).Lock(0xc000078408)
	/usr/lib/go-1.18/src/sync/rwmutex.go:144 +0x85
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run(0xc0000783c0, {0x939cb0, 0xc00000e270})
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:59 +0xb7
github.com/equilibristofgo/sandbox/05_race_condition/v4.TestRemoteJobRunner(0x0?)
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/main_test.go:33 +0x3ce
testing.tRunner(0xc00011aea0, 0x8cb5b0)
	/usr/lib/go-1.18/src/testing/testing.go:1439 +0x214
created by testing.(*T).Run
	/usr/lib/go-1.18/src/testing/testing.go:1486 +0x725

goroutine 5 [IO wait]:
internal/poll.runtime_pollWait(0x7eff6e227168, 0x72)
	/usr/lib/go-1.18/src/runtime/netpoll.go:302 +0x89
internal/poll.(*pollDesc).wait(0xc000160098, 0x203001?, 0x0)
	/usr/lib/go-1.18/src/internal/poll/fd_poll_runtime.go:83 +0xbd
internal/poll.(*pollDesc).waitRead(...)
	/usr/lib/go-1.18/src/internal/poll/fd_poll_runtime.go:88
internal/poll.(*FD).Accept(0xc000160080)
	/usr/lib/go-1.18/src/internal/poll/fd_unix.go:614 +0x425
net.(*netFD).accept(0xc000160080)
	/usr/lib/go-1.18/src/net/fd_unix.go:172 +0x4a
net.(*TCPListener).accept(0xc00000e228)
	/usr/lib/go-1.18/src/net/tcpsock_posix.go:139 +0x45
net.(*TCPListener).Accept(0xc00000e228)
	/usr/lib/go-1.18/src/net/tcpsock.go:288 +0x68
net/http.(*Server).Serve(0xc00017e000, {0x93a9b0, 0xc00000e228})
	/usr/lib/go-1.18/src/net/http/server.go:3039 +0x5a7
net/http/httptest.(*Server).goServe.func1()
	/usr/lib/go-1.18/src/net/http/httptest/server.go:308 +0xb3
created by net/http/httptest.(*Server).goServe
	/usr/lib/go-1.18/src/net/http/httptest/server.go:306 +0xa5

goroutine 6 [semacquire]:
sync.runtime_SemacquireMutex(0x49e479?, 0x57?, 0x81278f?)
	/usr/lib/go-1.18/src/runtime/sema.go:71 +0x25
sync.(*RWMutex).RLock(0xc000078408)
	/usr/lib/go-1.18/src/sync/rwmutex.go:63 +0x5b
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).setHeaders(0xc0000a2f80, 0xc0000aa000)
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:47 +0x6a
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).RemoteRun(0xc000078408?)
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:26 +0x8f
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*JobRunner).Run(0xc0000a2f80, {0x0?, 0x0?})
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/jobrunner.go:17 +0xba
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run(0xc0000783c0, {0x939cb0, 0xc00000e270})
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:57 +0xa8
created by github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Init
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:23 +0x185

goroutine 20 [semacquire]:
sync.runtime_SemacquireMutex(0x49fb85?, 0x25?, 0xc000078408?)
	/usr/lib/go-1.18/src/runtime/sema.go:71 +0x25
sync.(*Mutex).lockSlow(0xc000078408)
	/usr/lib/go-1.18/src/sync/mutex.go:162 +0x21d
sync.(*Mutex).Lock(0xc000078408)
	/usr/lib/go-1.18/src/sync/mutex.go:81 +0x65
sync.(*RWMutex).Lock(0xc000078408)
	/usr/lib/go-1.18/src/sync/rwmutex.go:139 +0x3e
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).Run(0xc0000783c0, {0x939cb0, 0xc00000e270})
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:59 +0xb7
github.com/equilibristofgo/sandbox/05_race_condition/v4.(*Job).StartWaiting.func1()
	/home/jose/git/equilibristofgo/sandbox/05_race_condition/v4/job.go:37 +0x4d
created by time.goFunc
	/usr/lib/go-1.18/src/time/sleep.go:176 +0x48
FAIL	github.com/equilibristofgo/sandbox/05_race_condition/v4	30.041s
FAIL
jose@